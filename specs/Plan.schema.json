{
  "$schema": "http://json-schema.org/draft/2020-12/schema",
  "title": "Execution Plan",
  "description": "Task DAG guiding the Integration phase",
  "type": "object",
  "required": ["plan_id", "version", "created_at", "tasks", "approvals"],
  "properties": {
    "plan_id": {
      "type": "string",
      "pattern": "^[a-z0-9][a-z0-9-]{1,63}$",
      "description": "Unique identifier for this plan"
    },
    "version": { "type": "string", "description": "Semver of the plan" },
    "created_at": { "type": "string", "format": "date-time", "description": "Creation timestamp" },
    "approvals": {
      "type": "object",
      "required": ["stage", "prod"],
      "properties": {
        "stage": { "type": "array", "items": { "type": "string" }, "description": "Human validation steps before stage" },
        "prod": { "type": "array", "items": { "type": "string" }, "description": "Human validation steps before prod" }
      },
      "additionalProperties": false
    },
    "tasks": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": [
          "task_id",
          "title",
          "status",
          "files_to_touch",
          "operations",
          "validation",
          "idempotency_signature",
          "implementor",
          "reviewer",
          "budget"
        ],
        "properties": {
          "task_id": {
            "type": "string",
            "pattern": "^task-[0-9]+$",
            "description": "Stable task identifier"
          },
          "title": { "type": "string", "description": "Short summary of the task" },
          "status": {
            "type": "string",
            "enum": ["pending", "in_progress", "blocked", "done"],
            "description": "Current task state"
          },
          "depends_on": { "type": "array", "items": { "type": "string" }, "description": "Prerequisite task IDs" },
          "external_dependencies": { "type": "array", "items": { "type": "string" }, "description": "IDs from dependencies.json" },
          "files_to_touch": { "type": "array", "items": { "type": "string" }, "description": "Paths allowed to change" },
          "operations": { "type": "array", "items": { "type": "string" }, "description": "High-level steps to perform" },
          "validation": { "type": "array", "items": { "type": "string" }, "description": "Commands or checks to verify" },
          "skip_if_satisfied": { "type": "array", "items": { "type": "string" }, "description": "Idempotency checks" },
          "return_envelope_contract": { "type": "object", "description": "Expectations for the ReturnEnvelope", "additionalProperties": true },
          "idempotency_signature": { "type": "string", "description": "Predicate proving task is complete" },
          "implementor": { "type": "string", "description": "Model/agent to execute the task" },
          "reviewer": { "type": "string", "description": "Model/agent to review the task" },
          "budget": {
            "type": "object",
            "required": ["max_usd", "max_calls"],
            "properties": {
              "max_usd": { "type": "number", "minimum": 0, "description": "Budget in USD" },
              "max_calls": { "type": "integer", "minimum": 1, "description": "Max model calls" }
            },
            "additionalProperties": false
          },
          "notes": { "type": "string", "description": "Additional comments" }
        },
        "additionalProperties": false
      }
    }
  },
  "additionalProperties": false
}
